{% extends "layout.html" %}

{% block content %}
<div class="chat-container">
    <!-- Chat Windows (one per task) -->
    <div class="chat-window active" id="chat-summarize">
        <div class="chat-header">
            <i class="bi-file-text"></i>
            <h2>Summarize</h2>
            <p>Condense information while preserving key points</p>
        </div>
        
        <div class="chat-history">
            <div class="message ai">
                <div class="avatar">
                    <i class="bi-robot"></i>
                </div>
                <div class="bubble">
                    Hello! I'm your Summarize assistant. Paste any text and I'll create a concise summary for you.
                </div>
            </div>
        </div>
        
        <!-- Thinking Indicator -->
        <div class="thinking-indicator" id="thinking-summarize">
            <div class="thinking-loader">
                <div class="brain-animation">
                    <div class="brain-part part1"></div>
                    <div class="brain-part part2"></div>
                    <div class="brain-part part3"></div>
                    <div class="brain-part part4"></div>
                </div>
                <p>Processing your request...</p>
            </div>
        </div>
        
        <div class="chat-input">
            <form action="/process" method="POST" class="chat-form" data-task="summarize">
                <input type="hidden" name="function" value="summarize">
                <textarea name="user_input" placeholder="Paste text to summarize..." required></textarea>
                <div class="input-footer">
                    <div class="char-counter">0/2000</div>
                    <button type="submit">
                        <i class="bi-send"></i> Summarize
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="chat-window" id="chat-explain">
        <div class="chat-header">
            <i class="bi-lightbulb"></i>
            <h2>Explain</h2>
            <p>Break down complex topics into simple explanations</p>
        </div>
        
        <div class="chat-history">
            <div class="message ai">
                <div class="avatar">
                    <i class="bi-robot"></i>
                </div>
                <div class="bubble">
                    Hi there! I'm your Explain assistant. Give me any concept or topic and I'll explain it clearly.
                </div>
            </div>
        </div>
        
        <!-- Thinking Indicator -->
        <div class="thinking-indicator" id="thinking-explain">
            <div class="thinking-loader">
                <div class="brain-animation">
                    <div class="brain-part part1"></div>
                    <div class="brain-part part2"></div>
                    <div class="brain-part part3"></div>
                    <div class="brain-part part4"></div>
                </div>
                <p>Processing your request...</p>
            </div>
        </div>
        
        <div class="chat-input">
            <form action="/process" method="POST" class="chat-form" data-task="explain">
                <input type="hidden" name="function" value="explain">
                <textarea name="user_input" placeholder="What would you like me to explain?" required></textarea>
                <div class="input-footer">
                    <div class="char-counter">0/2000</div>
                    <button type="submit">
                        <i class="bi-send"></i> Explain
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="chat-window" id="chat-translate">
        <div class="chat-header">
            <i class="bi-translate"></i>
            <h2>Translate</h2>
            <p>Convert text between languages with nuance</p>
        </div>
        
        <div class="chat-history">
            <div class="message ai">
                <div class="avatar">
                    <i class="bi-robot"></i>
                </div>
                <div class="bubble">
                    Bonjour! I'm your Translation assistant. I can translate between 50+ languages with cultural context.
                </div>
            </div>
        </div>
        
        <!-- Thinking Indicator -->
        <div class="thinking-indicator" id="thinking-translate">
            <div class="thinking-loader">
                <div class="brain-animation">
                    <div class="brain-part part1"></div>
                    <div class="brain-part part2"></div>
                    <div class="brain-part part3"></div>
                    <div class="brain-part part4"></div>
                </div>
                <p>Processing your request...</p>
            </div>
        </div>
        
        <div class="chat-input">
            <form action="/process" method="POST" class="chat-form" data-task="translate">
                <input type="hidden" name="function" value="translate">
                <textarea name="user_input" placeholder="Enter text to translate..." required></textarea>
                <div class="input-footer">
                    <div class="char-counter">0/2000</div>
                    <button type="submit">
                        <i class="bi-send"></i> Translate
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="chat-window" id="chat-code">
        <div class="chat-header">
            <i class="bi-code-slash"></i>
            <h2>Code</h2>
            <p>Generate, debug, and explain programming code</p>
        </div>
        
        <div class="chat-history">
            <div class="message ai">
                <div class="avatar">
                    <i class="bi-robot"></i>
                </div>
                <div class="bubble">
                    Hello, developer! I'm your Code assistant. I can help with code generation, debugging, and explanations.
                </div>
            </div>
        </div>
        
        <!-- Thinking Indicator -->
        <div class="thinking-indicator" id="thinking-code">
            <div class="thinking-loader">
                <div class="brain-animation">
                    <div class="brain-part part1"></div>
                    <div class="brain-part part2"></div>
                    <div class="brain-part part3"></div>
                    <div class="brain-part part4"></div>
                </div>
                <p>Processing your request...</p>
            </div>
        </div>
        
        <div class="chat-input">
            <form action="/process" method="POST" class="chat-form" data-task="code">
                <input type="hidden" name="function" value="code">
                <textarea name="user_input" placeholder="Describe what you need coded..." required></textarea>
                <div class="input-footer">
                    <div class="char-counter">0/2000</div>
                    <button type="submit">
                        <i class="bi-send"></i> Generate Code
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="chat-window" id="chat-creative">
        <div class="chat-header">
            <i class="bi-palette"></i>
            <h2>Creative</h2>
            <p>Generate ideas, stories, and artistic content</p>
        </div>
        
        <div class="chat-history">
            <div class="message ai">
                <div class="avatar">
                    <i class="bi-robot"></i>
                </div>
                <div class="bubble">
                    Hello creative mind! I'm your Creative assistant. Let's brainstorm ideas, write stories, or create art concepts.
                </div>
            </div>
        </div>
        
        <!-- Thinking Indicator -->
        <div class="thinking-indicator" id="thinking-creative">
            <div class="thinking-loader">
                <div class="brain-animation">
                    <div class="brain-part part1"></div>
                    <div class="brain-part part2"></div>
                    <div class="brain-part part3"></div>
                    <div class="brain-part part4"></div>
                </div>
                <p>Processing your request...</p>
            </div>
        </div>
        
        <div class="chat-input">
            <form action="/process" method="POST" class="chat-form" data-task="creative">
                <input type="hidden" name="function" value="creative">
                <textarea name="user_input" placeholder="What would you like to create?" required></textarea>
                <div class="input-footer">
                    <div class="char-counter">0/2000</div>
                    <button type="submit">
                        <i class="bi-send"></i> Create
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function appendMessage(role, message) {
  const chatBox = document.querySelector(".chat-messages");
  const msgDiv = document.createElement("div");
  msgDiv.className = role === "user" ? "message user" : "message ai";
  msgDiv.innerHTML = `<p>${message}</p>`;
  chatBox.appendChild(msgDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function showProcessing() {
  const btn = document.querySelector("#submitBtn");
  btn.disabled = true;
  btn.innerHTML = "üîÑ Processing...";
}

function hideProcessing() {
  const btn = document.querySelector("#submitBtn");
  btn.disabled = false;
  btn.innerHTML = "üöÄ Submit";
}

function pollResult(sessionId) {
  fetch(`/get_result/${sessionId}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === "completed") {
        appendMessage("ai", data.message);
        hideProcessing();
      } else if (data.status === "error") {
        appendMessage("ai", `‚ùå ${data.message}`);
        hideProcessing();
      } else {
        setTimeout(() => pollResult(sessionId), 2000); // try again after 2s
      }
    })
    .catch(err => {
      console.error("Polling failed:", err);
      appendMessage("ai", "‚ö†Ô∏è Something went wrong while getting the result.");
      hideProcessing();
    });
}

document.querySelector("#chatForm").addEventListener("submit", function (e) {
  e.preventDefault();
  const input = document.querySelector("#userInput");
  const value = input.value.trim();
  if (!value) return;

  appendMessage("user", value);
  showProcessing();

  const formData = new FormData(this);

  fetch("/process", {
    method: "POST",
    body: formData
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "queued") {
        pollResult(data.session_id);
      } else if (data.error) {
        appendMessage("ai", `‚ùå ${data.error}`);
        hideProcessing();
      }
    })
    .catch(err => {
      console.error("Request failed:", err);
      appendMessage("ai", "‚ö†Ô∏è Server error occurred.");
      hideProcessing();
    });

  input.value = "";
});
</script>
{% endblock %}